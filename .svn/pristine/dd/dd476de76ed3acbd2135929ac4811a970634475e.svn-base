String.implement({format:function(){if(arguments.length==0)return this;var a=arguments;return this.replace(/{(\d+)?}/g,function(b,d){return a[d.toInt()]||""})}});
var Scroller=new Class({Implements:[Events,Options],options:{area:20,velocity:1,onChange:function(a,b){this.element.scrollTo(a,b)}},initialize:function(a,b){this.setOptions(b);this.element=$(a);this.listener=typeOf(this.element)!="element"?$(this.element.getDocument().body):this.element;this.timer=null;this.coord=this.getCoords.bind(this)},start:function(){this.listener.addEvent("mousemove",this.coord)},stop:function(){this.listener.removeEvent("mousemove",this.coord);this.timer=clearInterval(this.timer)},
getCoords:function(a){this.page=this.listener.get("tag")=="body"?a.client:a.page;if(!this.timer)this.timer=this.scroll.periodical(50,this)},scroll:function(){var a=this.element.getSize(),b=this.element.getScroll(),d=this.element.getPosition(),c={x:0,y:0},e;for(e in this.page)if(this.page[e]<this.options.area+d[e]&&b[e]!=0)c[e]=(this.page[e]-this.options.area-d[e])*this.options.velocity;else if(this.page[e]+this.options.area>a[e]+d[e]&&a[e]+a[e]!=b[e])c[e]=(this.page[e]-a[e]+this.options.area-d[e])*
this.options.velocity;if(c.y||c.x)this.fireEvent("change",[b.x+c.x,b.y+c.y])}}),DragDropPlus=new Class({Implements:[Options,Events],options:{ddScope:window},initialize:function(a,b,d){this.dragSelecterString=a;this.dropSelecterString=b;this.drags=$$(a);this.drops=$$(b);this.setOptions(d);if(this.options.ddScope)this.winScroll=new Scroller(this.options.ddScope,{velocity:1});if(this.drag_operate_box=$("drag_operate_box")){this.drag_operate_box.store("lock",false);this.drag_handle_box=this.drag_operate_box.getElement(".drag_handle_box");
this.dobFx=new Fx.Morph(this.drag_operate_box,{fps:50,duration:200,link:"cancel"});this.dragSign=$("drag_ghost_box").inject(document.body);this.initDOBBase(this.drops);this.initDrags(this.drags);this.initDrops(this.drops)}},checkEmptyDropPanel:function(a){if(a&&a.hasClass(this.dropSelecterString.substring(1,this.dropSelecterString.length)))if(a.getElement(this.dragSelecterString))a.getElement(".empty_drop_box")&&a.getElement(".empty_drop_box").destroy();else if(!a.getElement(".empty_drop_box")){(new Element("div.empty_drop_box")).set("text",
LANG_dragdropplus.empty_box).inject(a);if(this.dragmoveInstance){a.store("droppanel",true);this.dragmoveInstance.droppables.include(a)}}},dragLeave:function(){},dargInject:function(a,b){var d=this.dragging;if(d){var c="inside";b.retrieve("droppanel")||(c=d.getAllPrevious().contains(b)?"before":"after");d.inject(b,c);this.checkEmptyDropPanel(a.retrieve("droped"));this.checkEmptyDropPanel(b);a.store("droped",b);this.dragSign.setStyles(d.getCoordinates())}},getDropables:function(){var a=this.dragging;
return Array.from(this.drags).erase(a).combine(this.drops.filter(function(b){if(b.getElement(this.dragSelecterString)){b.store("droppanel",false);return false}else{b.store("droppanel",true);return true}}.bind(this)))},initDOBBase:function(a){var b=this.drag_operate_box,d=this.drag_handle_box,c=this;if(a){var e=this.winScroll;d.getElement(".dhb_edit").addEvent("click",function(f){f.stop();this.fireEvent("onEdit",[b.retrieve("drag")],this)}.bind(this));d.getElement(".dhb_del").addEvent("click",function(f){f.stop();
this.fireEvent("onDelete",[b.retrieve("drag")],this)}.bind(this));d.getElement(".dhb_title").addEvents({mousedown:function(f){c.dragging=b.retrieve("drag");b.setStyle("left",b.getPosition().x+10);b.store("droped",c.dragging.getParent(c.dropSelecterString));b.store("lock",true);c.dragmoveInstance=new Drag.Move(b,{handle:this,droppables:c.getDropables.call(c),snap:0,preventDefault:true,onEnter:c.dargInject.bind(c),onStart:function(){c.dragSign.setStyles(Object.append(c.dragging.getCoordinates(),{visibility:"visible"}));
e&&e.start()},onComplete:function(){e&&e.stop();c.dobFx.start(c.dragging.getCoordinates()).chain(function(){this.element.store("lock",false)})}});c.dragmoveInstance.start(f)},mouseup:function(f){c.dragmoveInstance.stop(f);c.dragmoveInstance.cancel(f);c.dragmoveInstance.detach();c.dragSign&&c.dragSign.setStyle("visibility","hidden")}})}},initDrags:function(a){var b=this;a.each(function(d){b.fireEvent("onInitDrags",[d,a],this);d.addEvents({mouseenter:function(){var c=b.drag_operate_box;if(!c.retrieve("lock")){c.getElement(".dhb_title").set("html",
d.get("title")||"&nbsp;");c.setStyle("visibility","visible");c.store("drag",this);c=d.getCoordinates();c=Object.append(c,{height:c.height.limit(26,Number.MAX_VALUE)-2,width:c.width.limit(130,Number.MAX_VALUE)});b.dobFx.start(c)}}});d.getElements("a").removeEvents().addEvent("click",function(c){c.stop()});d.getElements("form").removeEvents().addEvent("submit",function(c){c.stop()})})},initDrops:function(a){var b=this;a.each(function(d){b.checkEmptyDropPanel(d);b.fireEvent("onInitDrops",[d,a],this)})}}),
Widgetsinsance=new Class({Extends:DragDropPlus,initialize:function(a,b,d){this.parent(a,b,d);this.drags.each(function(c){c.getProperty("ishtml")&&c.getElement(".content-html").set("html",c.getElement(".content-textarea").get("value"))})},inject:function(a,b){this.addWidget(this.curEl,a,b?b:this.theme)},ghostDrop:function(a,b){this.drag_operate_box.setStyle("visibility","hidden").store("lock",true);$("tempDropBox")&&$("tempDropBox").destroy();this.tempDropBox=(new Element("div",{id:"tempDropBox"})).inject(document.body);
try{this.drops.each(function(c,e){if(c){var f=this,g=c.getCoordinates();if(g.height>5&&g.width>5){g.height-=5;g.width-=5}(new Element("div",{"class":"widgets_drop_ghost",styles:Object.merge(g,{opacity:0.3}),text:"["+(e+1)+"]",title:LANG_shopwidgets.dropghostTitle1+a.name+LANG_shopwidgets.dropghostTitle2})).addEvents({mouseover:function(){this.addClass("widgets_drop_ghost_on")},mouseleave:function(){this.removeClass("widgets_drop_ghost_on")},click:function(){f.tempDropBox.empty();f.addWidget(c,a,b);
f.drag_operate_box.store("lock",false)}}).inject(f.tempDropBox)}},this)}catch(d){alert(JSON.encode(d))}document.body.addEvent("contextmenu",function(c){c.stop();$("tempDropBox")&&$("tempDropBox").destroy();this.drag_operate_box.store("lock",false);document.body.removeEvent("contextmenu",arguments.callee)}.bind(this))},copyWidgets:function(){},addWidget:function(a,b,d){this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?&app=site&ctl=admin_widget_proinstance&act=do_add_widgets&widgets="+b.name+
"&widgets_app="+b.app+"&widgets_theme="+b.theme+"&theme="+d,{modal:true,title:LANG_shopwidgets.addWidget+(b.label||""),ajaxoptions:{render:false},width:0.7,height:0.7});this.curDrop=a},editWidget:function(a){var b={modal:true,title:LANG_shopwidgets.editWidget+(a.label||""),ajaksable:false,width:0.7,height:0.7};this.curWidget=$(a);return this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?app=site&ctl=admin_widget_proinstance&act=do_edit_widgets&widgets_id="+a.get("widgets_id")+"&theme="+a.get("widgets_theme"),
b)}});
window.addEvent("domready",function(){document.body.style.cssText="background:#FFFFFF!important;padding:10px 90px 0 90px!important;";this.shopWidgets=new Widgetsinsance(".shopWidgets_box",".shopWidgets_panel",{onEdit:function(a){shopWidgets.editWidget(a)},onDelete:function(a,b){if(b||confirm(LANG_shopwidgets.comfirmDel)){var d=this.drag_operate_box,c=this;d.setStyle("visibility","hidden").store("lock",true);var e=a.getParent();(new Fx.Tween(a)).start("opacity",0).chain(function(){a.destroy();d.store("lock",
false);c.checkEmptyDropPanel(e);b&&b.call(top)})}}})});